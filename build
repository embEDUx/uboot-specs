#! /bin/bash -e

#####################
# Configuration     # 							     
#####################

### Sources
SRC_URL="http://ftp.denx.de/pub/u-boot/"
SRC_FILE="u-boot-2015.01-rc1.tar.bz2"
SRC_DIR="u-boot"

### Outputs
DST_CONF="rpi_b_config"
DST_IMG="u-boot.bin"
DST_TAR="u-boot.tar"
OUT_DIR="output"
DST_PRE="$(date '+%Y%m%d')_$(date '+%H-%M-%S')_2014.10"

#####################
# Script            #
#####################

### Fetch uboot sources
mkdir ${SRC_DIR}

wget ${SRC_URL}${SRC_FILE}
tar -xf ${SRC_FILE} -C ${SRC_DIR} --strip 1
rm ${SRC_FILE}

### Config
make -C ${SRC_DIR} ${DST_CONF}

### Uboot
make -C ${SRC_DIR} -j$(nproc)

### Copy files to output
mkdir ${OUT_DIR}

if [ -e ${SRC_DIR}/${DST_IMG} ]
	then tar -cf ${OUT_DIR}/${DST_PRE}_${DST_TAR} -C ${SRC_DIR} ${DST_IMG} 
fi

### Cleanup
rm -rf ${SRC_DIR}
